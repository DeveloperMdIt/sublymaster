name: Deploy to Netcup

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ErmÃ¶glicht manuelles Triggern

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸš€ Deploy to Server via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          cd /var/www/sublymaster
          
          # Git Pull
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          # Backend Deployment
          echo "ğŸ”§ Deploying Backend..."
          cd backend
          npm install --production
          mkdir -p logs
          pm2 restart sublymaster-backend || pm2 start ecosystem.config.js
          
          # Frontend Deployment
          echo "ğŸ¨ Deploying Frontend..."
          cd ../frontend
          npm install
          npm run build
          
          # Nginx Reload
          echo "ğŸ”„ Reloading Nginx..."
          sudo systemctl reload nginx || true
          
          echo "âœ… Deployment completed!"
          pm2 status
    
    - name: ğŸ“Š Deployment Status
      if: success()
      run: echo "âœ… Deployment to sublymaster.de successful!"
    
    - name: âŒ Deployment Failed
      if: failure()
      run: echo "âŒ Deployment failed! Check logs."
